name: Build Static Binaries

on:
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main
    paths:
      - "scripts/create-binaries.ts"
      - ".github/workflows/create-binaries.yml"

jobs:
  build-binaries:
    name: Build all platform binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0fb38de9
        with:
          go-version: "1.21"
          cache: false

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build all binaries
        run: npm run create-binaries

      - name: Verify binaries exist
        run: |
          ls -lh bin/
          file bin/keep-sorted*

      - name: Verify Linux binary is static
        run: |
          ldd bin/keep-sorted-linux-amd64 || echo "Binary is static (no dynamic dependencies)"

      - name: Upload binaries as artifacts
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a
        with:
          name: keep-sorted-binaries
          path: bin/
          if-no-files-found: error
          retention-days: 30

  commit-binaries:
    name: Commit binaries to repository
    needs: build-binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Download binaries
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: keep-sorted-binaries
          path: bin

      - name: Make binaries executable
        run: chmod +x bin/keep-sorted-*

      - name: Commit binaries
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bin/
          git diff --staged --quiet || git commit -m "chore: update static binaries [skip ci]"
          git push || echo "No changes to push"
